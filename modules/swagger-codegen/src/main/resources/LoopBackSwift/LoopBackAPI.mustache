import Foundation
import Alamofire
import RxSwift

public class LoopBackAPI {
    {{#apis}}public let {{apiVarName}}Api:{{apiClassName}}{{#hasMore}}
    {{/hasMore}}{{/apis}}

    public init(manager:Manager) {
        {{#apis}}{{apiVarName}}Api = {{apiClassName}}(manager: manager){{#hasMore}}
        {{/hasMore}}{{/apis}}
    }

    public func create<ModelType>(data:ModelType) throws -> Observable<ModelType> {
        {{#apis}}if data is {{modelClassName}} {
            return try {{apiVarName}}Api.create(data as! {{modelClassName}}).flatMap { return Observable.just($0 as! ModelType) }
        }{{#hasMore}}

        {{/hasMore}}{{/apis}}

        return Observable.create {
            $0.onError(Error.errorWithCode(0, failureReason: "Unsupported data type"))

            return NopDisposable.instance
        }
    }

    public func update<ModelType>(data:ModelType) throws -> Observable<ModelType> {
        {{#apis}}if data is {{modelClassName}} {
            return try {{apiVarName}}Api.update(data as! {{modelClassName}}).flatMap { return Observable.just($0 as! ModelType) }
        }{{#hasMore}}

        {{/hasMore}}{{/apis}}

        return Observable.create {
            $0.onError(Error.errorWithCode(0, failureReason: "Unsupported data type"))

            return NopDisposable.instance
        }
    }

    public func findById<ModelType>(type:ModelType.Type, id:String, filter:String) throws -> Observable<ModelType> {
        {{#apis}}if type == {{modelClassName}}.self {
            return try {{apiVarName}}Api.findById(id, filter: filter).flatMap { return Observable.just($0 as! ModelType) }
        }{{#hasMore}}

        {{/hasMore}}{{/apis}}

        return Observable.create {
            $0.onError(Error.errorWithCode(0, failureReason: "Unsupported data type"))

            return NopDisposable.instance
        }
    }

    public func findOne<ModelType>(type:ModelType.Type, filter:String) throws -> Observable<ModelType> {
        {{#apis}}if type == {{modelClassName}}.self {
            return try {{apiVarName}}Api.findOne(filter: filter).flatMap { return Observable.just($0 as! ModelType) }
        }{{#hasMore}}

        {{/hasMore}}{{/apis}}

        return Observable.create {
            $0.onError(Error.errorWithCode(0, failureReason: "Unsupported data type"))

            return NopDisposable.instance
        }
    }

    public func find<ModelType>(type:ModelType.Type, filter:String) throws -> Observable<[ModelType]> {
        {{#apis}}if type == {{modelClassName}}.self {
            return try {{apiVarName}}Api.find(filter: filter).flatMap { return Observable.just($0.map({ return $0 as! ModelType })) }
        }{{#hasMore}}

        {{/hasMore}}{{/apis}}

        return Observable.create {
            $0.onError(Error.errorWithCode(0, failureReason: "Unsupported data type"))

            return NopDisposable.instance
        }
    }

    public func count<ModelType, CountType>(type:ModelType.Type, _where:String) throws -> Observable<CountType> {
        {{#apis}}if type == {{modelClassName}}.self {
            return try {{apiVarName}}Api.count(_where).flatMap { return Observable.just($0 as! CountType) }
        }{{#hasMore}}

        {{/hasMore}}{{/apis}}

        return Observable.create {
            $0.onError(Error.errorWithCode(0, failureReason: "Unsupported data type"))

            return NopDisposable.instance
        }
    }

    public func deleteById<ModelType, DeleteType>(type:ModelType.Type, id:String) throws -> Observable<DeleteType> {
        {{#apis}}if type == {{modelClassName}}.self {
            return try {{apiVarName}}Api.deleteById(id).flatMap { return Observable.just($0 as! DeleteType) }
        }{{#hasMore}}

        {{/hasMore}}{{/apis}}

        return Observable.create {
            $0.onError(Error.errorWithCode(0, failureReason: "Unsupported data type"))

            return NopDisposable.instance
        }
    }
}